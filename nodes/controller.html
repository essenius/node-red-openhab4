<!--
 Copyright 2025-2026 Rik Essenius

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License. You may obtain a copy of the License at

   http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software distributed under the License is
 distributed on an "AS IS" BASIS WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and limitations under the License.
-->

<script type="text/x-red" data-template-name="openhab4-controller">
    <div class="form-row">
        <label for="node-config-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-config-input-name" placeholder="Name (leave empty to take URL)">
    </div>

    <div class="form-row">
        <label for="node-config-input-url"><i class="fa fa-link"></i> URL</label>
        <input type="text" id="node-config-input-url" placeholder="Base URL of OpenHAB">
        <div id="url-warning" style="color: #d9534f; font-size: 0.9em; display: none;"></div>
    </div>

    <div class="form-row" style="display: flex; align-items: center; flex-wrap: nowrap;">
        <label for="node-config-input-allowSelfSigned" style="margin: 0; white-space: nowrap;"><i class="fa fa-certificate"></i> Certificates</label>
        <div style="margin-left: 1em; display: flex; align-items: center; white-space: nowrap;">
            <input type="checkbox" id="node-config-input-allowSelfSigned" style="margin-right: 0.5em;">
            <span>Allow self signed</span>
        </div>
    </div>

    <div class="form-row">
        <label for="node-config-input-token"><i class="fa fa-user"></i> Token</label>
        <input type="password" id="node-config-input-token" placeholder="API token generated by OpenHAB">
        <div id="token-warning" style="color: #d9534f; font-size: 0.9em; display: none;">
            ⚠ Bearer token requires HTTPS. Token has been cleared.
        </div>
    </div>
    <div class="form-row">
        <label for="node-config-input-username"><i class="fa fa-user"></i> User name</label>
        <input type="text" id="node-config-input-username" placeholder="OpenHAB user name (if no API token used)">
    </div>
    <div class="form-row">
        <label for="node-config-input-password"><i class="fa fa-user-secret"></i> Password</label>
        <input type="password" id="node-config-input-password" placeholder="Password of OpenHAB user (if no API token used)">
    </div>

    <div class="form-row">
        <label for="node-config-input-eventFilter"><i class="fa fa-filter"></i> Event Filter</label>
        <input type="text" id="node-config-input-eventFilter" placeholder="Comma separated topics, e.g. */items/* for all item events">
        <p class="form-tips">comma separated topics, e.g. */items/* for all item events.</p>
    </div>

    <div class="form-row">
        <label for="node-config-input-retryTimeout"><i class="fa fa-clock-o"></i> Retry timeout</label>
        <input type="number" id="node-config-input-retryTimeout">
    </div>
    <input type="hidden" id="node-config-input-hash" />

</script>

{{HELP}}

<script src="openhab4/ui-constants.js"></script>

<script type="text/javascript">


    function configField(name) {
        return document.getElementById(`node-config-input-${name}`);
    }

    function getFields() {
        const urlField = configField("url");
        const urlWarning = document.getElementById("url-warning");
        const tokenField = configField("token");
        const tokenWarning = document.getElementById("token-warning");
        const userField = configField("username");
        const passwordField = configField("password");
        const allowSelfSignedField = configField("allowSelfSigned");
        const hashField = configField("hash");

        return {
            urlField, urlWarning, tokenField, tokenWarning,
            userField, passwordField, allowSelfSignedField, hashField
        };
    }

    // Simple 32-bit numeric hash for controller properties
    function getHash(props) {

        const str = props.join("|"); // simple delimiter
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
            hash = ((hash << 5) - hash) + str.codePointAt(i);
            hash = Math.trunc(hash); // Convert to 32-bit integer
        }
        return hash >>> 0; // Unsigned
    }

    function setControllerHash() {
        const { urlField, tokenField, userField, passwordField, allowSelfSignedField, hashField } = getFields();
        const controllerData = [
            urlField.value,
            tokenField.value || '',
            userField.value || '',
            passwordField.value || '',
            allowSelfSignedField.value
        ];
        console.log("controllerData in setControllerHash", controllerData);
        hashField.value = getHash(controllerData);
        return hashField.value;
    }

    function isValidUrl(urlString) {
        try {
            new URL(urlString);
            return true;
        } catch {
            return false;
        }
    }

    function setDisabled(field, disabled) {
        field.disabled = disabled;
        const row = field.closest(".form-row");
        if (row) {
            row.classList.toggle("disabled", disabled);
        }
    }

    function stripProtocol(url) {
        return url.replace(/^https?:\/\//i, '');
    }

    RED.nodes.registerType('openhab4-controller', {
        category: 'config',
        defaults: {
            name: { value: "", required: true },
            url: { value: "https://localhost:8443/", required: true },
            allowSelfSigned: { value: false, required: true },
            eventFilter: { value: "*", required: true },
            retryTimeout: { value: "", required: false },
            hash: { value: "" }
        },
        credentials: {
            token: { type: "password" },
            username: { type: "text" },
            password: { type: "password" }
        },
        paletteLabel: "openhab4-controller",
        label: function () { return this.name || stripProtocol(this.url); },
        labelStyle: function () { return this.name ? "node_label_italic" : ""; },
        oneditsave: function () {
            this.hash = setControllerHash();
            console.log("Set hash:", configField("hash").value);
        },
        oneditprepare: function () {
            const { urlField, urlWarning, tokenField, tokenWarning,
                userField, passwordField, allowSelfSignedField } = getFields();

            function updateAuthFields() {
                const url = urlField.value.trim();
                const isHttps = url.toLowerCase().startsWith("https://");
                setDisabled(allowSelfSignedField, !isHttps);
                const hasToken = !!tokenField.value;
                const hasUser = !!userField.value;

                if (hasToken) {
                    if (isHttps) {
                        tokenWarning.style.display = "none";
                    } else {
                        tokenField.value = "";
                        tokenWarning.style.display = "block";
                    }
                    setDisabled(tokenField, !isHttps);
                    setDisabled(userField, isHttps);
                    setDisabled(passwordField, isHttps);
                } else {
                    setDisabled(tokenField, hasUser || !isHttps);
                    setDisabled(userField, false);
                    setDisabled(passwordField, false);
                }
            }

            function checkUrl() {
                if (urlField.value.trim() === "" || isValidUrl(urlField.value.trim())) {
                    urlWarning.style.display = "none";
                    return;
                }
                urlWarning.textContent = "⚠ Invalid URL";
                urlWarning.style.display = "block";
            }

            urlField.addEventListener("input", updateAuthFields);
            urlField.addEventListener("input", checkUrl);
            tokenField.addEventListener("input", updateAuthFields);
            userField.addEventListener("input", updateAuthFields);

            updateAuthFields();
        }
    });
</script>