<!--
 Copyright 2025-2026 Rik Essenius

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License. You may obtain a copy of the License at

   http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software distributed under the License is
 distributed on an "AS IS" BASIS WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and limitations under the License.
-->

<script type="text/x-red" data-template-name="openhab4-out">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-controller"><i class="fa fa-cogs"></i> Controller</label>
        <input type="text" id="node-input-controller">
    </div>
    <div class="form-row">
        <label for="node-input-list-filter"><i class="fa fa-filter"></i> Filter Items</label>
        <input type="text" id="node-input-list-filter" placeholder="Type to filter below item name list...">
    </div>
    <div class="form-row">
        <label for="node-input-identifier"><i class="fa fa-crosshairs"></i> Item Name</label>
    	<select id="node-input-identifier" name="node-input-identifier">
    	</select>
    </div>
    <div class="form-row">
        <label for="node-input-operation"><i class="fa fa-tasks"></i> Operation</label>
    	<select id="node-input-operation" name="node-input-operation" style="width: 250px;">
			<option value="command">Command</option>
			<option value="update">Update</option>
    	</select>
    </div>
    <div class="form-row">
        <label for="node-input-payload"><i class="fa fa-envelope"></i> Payload</label>
        <input type="text" id="node-input-payload" placeholder="Payload">
    </div>
    <div class="form-row">
        <label for="node-input-priority"><i class="fa fa-sort"></i> Priority</label>
        <select id="node-input-priority" name="node-input-priority">
			<option value="config">Configuration first</option>
            <option value="message">Message first</option>
        </select>
    </div>
</script>

<script type="text/x-red" data-help-name="openhab4-out">
    <div style="color: #b58900; margin-bottom: 1em;">
        <i class="fa fa-exclamation-triangle"></i>
        <strong>Tip:</strong> If you have just imported a flow or reused a controller configuration node, open and save the controller config node to ensure credentials and item lists are available in this node.
    </div>
    <p>Sends commands or state updates to an openHAB Item.</p>
    
    <h3>Configuration</h3>
    <dl class="message-properties">
        <dt>Name <span class="property-type">string</span></dt>
        <dd>Optional name for the node (auto-generated from item name if empty)</dd>
        <dt>Controller <span class="property-type">openhab4-controller</span></dt>
        <dd>The openHAB4 controller to use</dd>
        <dt>Filter List <span class="property-type">string</span></dt>
        <dd>Text to filter the list of items with. Leave empty to show all items.</dd>
        <dt>Item Name <span class="property-type">string</span></dt>
        <dd>The openHAB item to send commands/updates to. Pairs with <code>msg.topic</code></dd>
        <dt>Operation <span class="property-type">string</span></dt>
        <dd>The type of operation: <code>ItemCommand</code> or <code>ItemUpdate</code>. Pairs with <code>msg.openhabControl.operation</code></dd>
        <dt>Payload <span class="property-type">string</span></dt>
        <dd>The command or update value to send. Pairs with <code>msg.payload</code></dd>
        <dt>Priority <span class="property-type">string</span></dt>
        <dd>Whether message properties override config properties or or vice versa.</dd>
    </dl>

    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt>payload <span class="property-type">string | object</span></dt>
        <dd>The value to send to the item</dd>
        <dt>topic <span class="property-type">string</span></dt>
        <dd>The address of the item to send the command/update to (e.g. items/myItem). Only items are supported; if no slash is included, it is assumed to be an item name.</dd>
        <dt>openhabControl.operation <span class="property-type">string</span></dt>
        <dd>The type of operation: <code>Command</code> or <code>Update</code>.</dd>
    </dl>

    <h3>Outputs</h3>
    <ol class="node-ports">
        <li>Sent Message
            <dl class="message-properties">
                <dt>payload <span class="property-type">string | object</span></dt>
                <dd>The payload that was sent</dd>
                <dt>topic <span class="property-type">string</span></dt>
                <dd>The address (items/itemName) of the item that received the command/update</dd>
                <dt>openhabControl.operation <span class="property-type">string</span></dt>
                <dd>The type of operation that was performed</dd>
                dt>input <span class="property-type">object</span></dt>
                <dd>The original input message that triggered the command/update</dd>
            </dl>
        </li>
    </ol>

    <h3>Details</h3>
    <p>This node sends commands or state updates to openHAB items:</p>
    <ul>
        <li><strong>Command:</strong> Sends a command to an item (e.g., turn a switch ON/OFF)</li>
        <li><strong>Update:</strong> Updates the state of an item directly</li>
    </ul>
    
    <p>Message properties take precedence over node configuration. 
    If no item is specified in either the configuration or message, an error will be generated.</p>
    
    <p>The node will only generate output if the command/update was sent successfully.</p>
</script>

<script src="openhab4/ui-constants.js"></script>
<script src="openhab4/ui-utils.js"></script>

<script type="text/javascript">
    RED.nodes.registerType('openhab4-out', {
        category: 'home automation',
        color: globalThis.OPENHAB4.NODE_COLOR,
        defaults: {
            name: { value: "" },
            controller: { value: "", type: "openhab4-controller", required: true },
            concept: { value: "items", required: true },
            identifier: { value: "", required: false },
            operation: { value: "update", required: true },
            payload: { value: "", required: false },
            priority: { value: "config", required: true }
        },
        inputs: 1,
        outputs: 1,
        outputLabels: ["sent message"],
        icon: "openhab4-logo-out.svg",
        paletteLabel: "openhab4-out",
        label: function () {
            return globalThis.OPENHAB4.generateNodeName('out', this.name, this.identifier);
        },
        labelStyle: function() {
            return this.name ? "node_label_italic" : "";
        },

        oneditsave: function() { openhabEditSave(RED, this); },
        oneditprepare: function () { openhabEditPrepare(RED, this, "[No Item]"); },
        oneditcancel: function () { openhabEditCancel(RED, this); }

    });
</script>